name: build-deploy-appflowy

env:
  IMAGE_NAME: appflowy-cloud
  CONTAINER_NAME: appflowy-cloud
  REMOTE_DIR: /home/ubuntu/appflowy

on:
  workflow_dispatch:
  push:
    branches: [ dev ]
    paths-ignore:
      - '*.md'
      - '.gitignore'
      - 'docs/'
      - 'README.md'

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-flags: --debug
          config-inline: |
            [worker.oci]
              max-parallelism = 2

      - name: Set up environment
        run: |
          echo "${{ secrets.EC2_ENV }}" > .env
          echo "IMAGE_NAME=${{ env.IMAGE_NAME }}" >> .env
          echo "CONTAINER_NAME=${{ env.CONTAINER_NAME }}" >> .env

      - name: Clean up unused Docker resources
        run: docker system prune -af

      - name: Build Docker images
        run: |
          # Free up space
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          df -h

          # Build images with increased memory limit and debug output
          DOCKER_BUILDKIT=1 PROGRESS_NO_TRUNC=1 docker compose build \
            --no-cache \
            --build-arg DOCKER_MEMORY=6g \
            --build-arg CARGO_NET_GIT_FETCH_WITH_CLI=true \
            --build-arg CARGO_BUILD_JOBS=2
          
          docker images

      - name: Save Docker images
        run: |
          mkdir -p docker-images
          # Save and compress each image
          for service in appflowy_cloud gotrue admin_frontend appflowy_web appflowy_ai appflowy_worker; do
            docker save appflowyinc/${service}:latest | gzip > docker-images/${service}.tar.gz
          done
          # Save third-party images
          docker save minio/minio:latest | gzip > docker-images/minio.tar.gz
          docker save pgvector/pgvector:pg16 | gzip > docker-images/postgres.tar.gz
          docker save redis:latest | gzip > docker-images/redis.tar.gz
          docker save nginx:latest | gzip > docker-images/nginx.tar.gz
          
          # List all saved images
          ls -lh docker-images/

      - name: Setup SSH
        run: |
          echo "${{ secrets.EC2_KEY }}" >> id_rsa
          chmod 400 id_rsa

      - name: Copy files to server
        run: |
          ssh -i id_rsa -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'ENDSSH'
          sudo rm -rf ${{ env.REMOTE_DIR }}
          sudo mkdir -p ${{ env.REMOTE_DIR }}
          sudo chown -R ubuntu:ubuntu ${{ env.REMOTE_DIR }}
          ENDSSH
          
          # Copy project files excluding unnecessary ones
          # Create a temporary exclude file
          echo ".git" > exclude.txt
          echo ".github" >> exclude.txt
          echo ".env" >> exclude.txt
          echo ".docker.env" >> exclude.txt
          echo "docker-images" >> exclude.txt
          
          # Use scp with the exclude file
          scp -r -o StrictHostKeyChecking=no $(cat exclude.txt | while read line; do echo "-E $line"; done) \
            ./* ubuntu@${{ secrets.EC2_HOST }}:${{ env.REMOTE_DIR }}/
          
          # Clean up
          rm exclude.txt
          
          # Copy Docker images and config files
          ssh -i id_rsa -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} "mkdir -p ${{ env.REMOTE_DIR }}/docker-images"
          scp -i id_rsa -o StrictHostKeyChecking=no -r docker-images/* ubuntu@${{ secrets.EC2_HOST }}:${{ env.REMOTE_DIR }}/docker-images/
          scp -i id_rsa -o StrictHostKeyChecking=no docker-compose.yml ubuntu@${{ secrets.EC2_HOST }}:${{ env.REMOTE_DIR }}/
          scp -i id_rsa -o StrictHostKeyChecking=no .env ubuntu@${{ secrets.EC2_HOST }}:${{ env.REMOTE_DIR }}/

      - name: Deploy with rollback
        run: |
          ssh -i id_rsa -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'ENDSSH'
          set -e
          cd ${{ env.REMOTE_DIR }}
          
          # Setup docker permissions
          sudo groupadd -f docker
          sudo usermod -aG docker ubuntu
          sudo chmod 666 /var/run/docker.sock
          
          # Create required directories with proper permissions
          sudo mkdir -p nginx/ssl
          sudo chown -R ubuntu:ubuntu .
          
          # Clean up existing containers and volumes
          sudo docker compose down -v || true
          sudo docker system prune -af || true
          
          # Remove existing images
          for service in appflowy_cloud gotrue admin_frontend appflowy_web appflowy_ai appflowy_worker minio postgres redis nginx; do
            sudo docker rmi $(basename $service):latest || true
          done

          # Load new images
          echo "Loading Docker images..."
          cd docker-images
          for image in *.tar.gz; do
            echo "Loading $image..."
            sudo gunzip -c $image | sudo docker load
          done
          cd ..

          # Deploy with docker-compose
          sudo docker compose up -d
          
          # Wait for containers to start
          sleep 10
          
          # Verify deployment
          if ! sudo docker compose ps | grep -q "Up"; then
            echo "Deployment failed, containers are not running"
            sudo docker compose logs
            exit 1
          fi
          
          echo "Deployment successful!"
          ENDSSH

      - name: Cleanup
        if: always()
        run: |
          rm -f id_rsa
          rm -f .env
          rm -rf docker-images
          docker system prune -f
